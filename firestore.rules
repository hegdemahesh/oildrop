rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() { return request.auth != null; }
    function isOwner() { return signedIn() && get(/databases/$(database)/documents/roles/$(request.auth.uid)).data.role == 'owner'; }
    function isAdminOrOwner() {
      return signedIn() && (
        get(/databases/$(database)/documents/roles/$(request.auth.uid)).data.role in ['admin','owner']
      );
    }

    match /inventory/{id} {
      allow read: if signedIn();
      allow create, update, delete: if isAdminOrOwner();
    }
    match /customers/{id} {
      // Demo relaxation: allow all signed-in users to read customers
      // Fields include: name, phone, altPhone, gstNumber, email, address, balance, createdAt, updatedAt
      allow read: if signedIn();
      allow create, update: if isAdminOrOwner();
      allow delete: if isOwner();
    }
    match /invoices/{id} {
      allow read: if isAdminOrOwner();
      allow create: if isAdminOrOwner();
      allow update, delete: if false; // immutable once written
    }
    // Sales collection (was missing -> caused 'No matching allow statements')
    match /sales/{id} {
      // Allow any signed-in user to read sales
      allow read: if signedIn();
      // Restrict modifications to admins/owners
      allow create, update, delete: if isAdminOrOwner();
    }

    // Payments subcollection under customers
    match /customers/{customerId}/payments/{paymentId} {
      allow read: if signedIn();
      allow create: if isAdminOrOwner();
      // No updates/deletes for historical integrity (can adjust if needed)
    }
    match /roles/{uid} {
      allow read: if isAdminOrOwner();
      allow write: if isOwner();
    }
  }
}
